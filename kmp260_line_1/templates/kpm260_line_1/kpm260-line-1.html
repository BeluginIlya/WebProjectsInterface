{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд принтера</title>
    <style>
        body {
            overflow: hidden;

            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .header {
            text-align: center;
            padding: 5px; /* Увеличение отступов вокруг заголовка */
            font-size: 30px; /* Увеличение размера шрифта в заголовке */
            background-color: #333;
            color: #fff;
            display: flex; /* Использование flexbox для размещения в два столбца */
            justify-content: space-between;
        }

        .info-header-1,
        .info-header-2 {
            flex: 1; /* Равномерное распределение места между двумя столбцами */
            padding: 5px;
        }

        .info-header-1,
        .info-header-2, p {
            margin-top: 7px;
            margin-bottom: 7px;
        }

        .dashboard {
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            width: 80%; /* Adjust the width as needed */
            box-sizing: border-box;
            margin: 5px;
            background-color: #fff;
            font-size: 50px;
        }

        .product-card.selected-card {
            border: 5px solid red;
        }

        th, td {
            text-align: left;
        }

        .check-mark::before {
            content: '\2713';
            color: green;
            font-weight: bold;
        }

        .cross-mark::before {
            content: '\2717';
            color: red;
            font-weight: bold;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>

    <div class="header">
        <div class="info-header-1">
            <p id="tech-post">Технологический пост: ТП 1</p>
            <p id="current-pal">Текущий номер палеты: -</p>
        </div>
        <div class="info-header-2">
            <p id="printer-status">Статус принтера: -</p>
            <p></p>
        </div>
    </div>
    
    <div class="dashboard">
        <!-- Product Cards will be dynamically added here -->
    </div>

    <script>
        var selectedCard = null;

        function updateDashboard(data) {
            var dashboard = $('.dashboard');
            dashboard.empty();

            data.forEach(function (product) {
                var card = $('<div class="product-card">');
                card.append('<p>№ Изд.: ' + product.NumProd + '</p>');
                card.append('<p>Дата и Время: ' + product.Timestamp + '</p>');
                card.append('<p>Штрихкод: ' + product.Barcode + '</p>');
                card.append('<p>Наименование продукта: ' + product.Product + '</p>');

                var statusIcon = $('<span>');
                statusIcon.addClass(product.StatusPrint ? 'check-mark' : 'cross-mark');
                card.append('<p>Статус: ' + statusIcon[0].outerHTML + '</p>');

                if (selectedCard && selectedCard.NumProd === product.NumProd) {
                    card.addClass('selected-card');
                }

                // card.on('click', function () {
                //     selectedCard = product;
                //     updateDashboard(data); // Refresh to apply selected styles
                // });

                dashboard.append(card);
            });
        }
        
        function connectWebSocket() {
            var ipAddress = '{{ ip_address }}';
            var port = '{{ port }}';
            var socket = new WebSocket('ws://' + ipAddress + ':' + port + '/ws/data_updates/');

            socket.onopen = function (event) {
                console.log('WebSocket connection opened');
                send_command(socket, 'GET DATA');
            }
                

            socket.onmessage = function (event) {
                console.log('Сообщение подключения');
                var message = JSON.parse(event.data);
                if (message.type === 'data.updated') {
                    var data = JSON.parse(message.data)
                    console.log(data);
                    if (data.internal_type === 'table_updated') {
                        updateDashboard(data.event_data);
                    }
                    else if (data.internal_type === 'status_updated') {
                        read_printer_status(socket, data.event_data);
                    }
                }
            };

            socket.onclose = function (event) {
                console.error('WebSocket connection closed:', event);
                setTimeout(connectWebSocket, 1000);
            };
        }

        function read_printer_status(socket=null, data) {
            console.log('Продумать как обработать данные. статусы: NEXT, LAST PAL, PRINT, WAIT, NOT CONNECT');

            var printerStatusElement = document.getElementById('printer-status');
            var currentPalElement = document.getElementById('current-pal');
            var dashboard = $('.dashboard');

            if (data.status_printer === 'WAIT' || data.status_printer === 'NOT CONNECT') {
                printerStatusElement.textContent = 'Статус принтера: ' + (data.status_printer === 'WAIT' ? 'Ожидает' : 'Нет соединения');
                currentPalElement.textContent = 'Текущий номер палеты: -';
                selectedCard = null;
                
                // Display loading indicator or any other appropriate content
                dashboard.html('<div class="loading-indicator">Loading...</div>');
            } else if (data.status_printer === 'PRINT') {
                printerStatusElement.textContent = 'Статус принтера: Печатает';
                currentPalElement.textContent = 'Текущий номер палеты: ' + data.body.PalNo;
                selectedCard = data.body; 
                
            } else if (data.status_printer === 'LAST PAL') {
                printerStatusElement.textContent = 'Статус принтера: Предыдущая палета';
                currentPalElement.textContent = 'Текущий номер палеты: -';
                selectedCard = null;
                
                // Display loading indicator or any other appropriate content
                dashboard.html('<div class="loading-indicator">Loading...</div>');
            }

            // Always request data after handling the status
            send_command(socket, 'GET DATA');
        }

        function send_command(socket, command) {
            var request_data = {'message': command};
            try {
                socket.send(JSON.stringify(request_data));
            } catch (error) {
                console.error('Error sending message:', error);
            }
        };
        

        function highlightRow(PalNo, NumProd, Barcode) {
            // If needed for highlighting specific row in a table
        }

        $(document).ready(function () {
            connectWebSocket();
        });
    </script>
</body>

</html>
